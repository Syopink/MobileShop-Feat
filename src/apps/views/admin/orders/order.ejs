<%- include("../layout/head.ejs", {title: "Order Manager" })%> 
<%- include("../layout/header.ejs")%> 
<%- include("../layout/sidebar.ejs")%>

<div class="col-sm-9 col-sm-offset-3 col-lg-10 col-lg-offset-2 main">

  <!-- Breadcrumb -->
  <div class="row">
    <ol class="breadcrumb">
      <li>
        <a href="/admin/dashboard">
          <svg class="glyph stroked home">
            <use xlink:href="#stroked-home"></use>
          </svg>
        </a>
      </li>
      <li class="active">Danh sách đơn hàng</li>
    </ol>
  </div>

  <!-- Tiêu đề -->
  <div class="row">
    <div class="col-lg-12">
      <h1 class="page-header">Quản lý đơn hàng</h1>
    </div>
  </div>

  <!-- ✅ Bộ lọc -->
  <div class="row">
    <div class="col-lg-12">
      <div class="panel panel-default">
        
        <div class="panel-body">
          <form method="GET" action="/admin/orders" class="form-inline">
            
            <div class="form-group" style="margin-right: 10px;">
              <label>Phương thức thanh toán:</label>
              <select name="payment_method" class="form-control">
                <option value="">Tất cả</option>
                <option value="cod" <%= filter?.payment_method === 'cod' ? 'selected' : '' %>>COD</option>
                <option value="vnpay" <%= filter?.payment_method === 'vnpay' ? 'selected' : '' %>>VNPay</option>
              </select>
            </div>

            <div class="form-group" style="margin-right: 10px;">
              <label>Trạng thái thanh toán:</label>
              <select name="payment_status" class="form-control">
                <option value="">Tất cả</option>
                <option value="unpaid" <%= filter?.payment_status === 'unpaid' ? 'selected' : '' %>>Chưa thanh toán</option>
                <option value="paid" <%= filter?.payment_status === 'paid' ? 'selected' : '' %>>Đã thanh toán</option>
              </select>
            </div>

            <div class="form-group" style="margin-right: 10px;">
              <label>Trạng thái giao hàng:</label>
              <select name="status" class="form-control">
                <option value="">Tất cả</option>
                <option value="0" <%= filter?.status === '0' ? 'selected' : '' %>>Đã hủy</option>
                <option value="1" <%= filter?.status === '1' ? 'selected' : '' %>>Đã giao</option>
                <option value="2" <%= filter?.status === '2' ? 'selected' : '' %>>Đang xử lý</option>
              </select>
            </div>

            <button type="submit" class="btn btn-primary">
              <i class="glyphicon glyphicon-search"></i> Lọc
            </button>

            <a href="/admin/orders" class="btn btn-default">
              <i class="glyphicon glyphicon-refresh"></i> Reset
            </a>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ Danh sách đơn hàng -->
  <div class="row">
    <div class="col-lg-12">
      <div class="panel panel-default">
        <div class="panel-heading">
          Danh sách đơn hàng (Tổng: <%= totalOrders || orders.length %>)
        </div>

        <div class="panel-body">
          <div class="table-responsive">
            <table class="table table-striped table-bordered table-hover">
              <thead>
                <tr>
                  <th style="width: 80px;">Mã đơn</th>
                  <th style="width: 120px;">Mã GHN</th>
                  <th style="width: 150px;">Khách hàng</th>
                  <th style="width: 100px;">Ngày tạo</th>
                  <th style="width: 120px;">Tổng tiền</th>
                  <th style="width: 100px; text-align:center;">PT TT</th>
                  <th style="width: 120px; text-align:center;">TT TT</th>
                  <th style="width: 120px; text-align:center;">TT GH</th>
                  <th style="width: 100px; text-align:center;">Thao tác</th>
                </tr>
              </thead>
              <tbody>
                <% if(orders.length === 0){ %>
                  <tr>
                    <td colspan="9" style="text-align:center">
                      <i class="glyphicon glyphicon-info-sign"></i> Không có đơn hàng nào
                    </td>
                  </tr>
                <% } else { %>
                  <% orders.forEach(order => { %>
                    <tr>
                      <td><strong>#<%= order._id.toString().slice(-6) %></strong></td>
                      <td>
                        <% if(order.ghn_order_code){ %>
                          <code style="font-size:11px;"><%= order.ghn_order_code %></code>
                        <% } else { %>
                          <span class="text-muted">-</span>
                        <% } %>
                      </td>
                      <td>
                        <strong><%= order.name %></strong><br>
                        <small class="text-muted">
                          <i class="glyphicon glyphicon-phone"></i> <%= order.phone %>
                        </small>
                      </td>
                      <td style="white-space:nowrap;">
                        <%= moment(order.createdAt).format("DD/MM/YYYY") %><br>
                        <small class="text-muted"><%= moment(order.createdAt).format("HH:mm") %></small>
                      </td>
                      <td style="white-space:nowrap;">
                        <strong class="text-danger"><%= vndPrice(order.totalPrice + (order.shippingFee || 0)) %></strong>
                      </td>
                      <td style="text-align:center;">
                        <% if(order.payment_method === 'vnpay'){ %>
                          <span class="label label-primary">VNPay</span>
                        <% } else { %>
                          <span class="label label-warning">COD</span>
                        <% } %>
                      </td>
                      <td style="text-align:center;">
                        <% if(order.payment_status === 'paid'){ %>
                          <span class="label label-success">Đã TT</span>
                        <% } else { %>
                          <span class="label label-default">Chưa TT</span>
                        <% } %>
                      </td>
                     <td style="text-align:center;">
  <% if(order.status === 0){ %>
    <span class="label label-danger">Đã hủy</span>
  <% } else if(order.status === 1){ %>
    <span class="label label-success">Đã giao</span>
  <% } else if(order.status === 2){ %>
    <span class="label label-info">Đang xử lý</span>
  <% } else if(order.status === 3){ %>
    <span class="label label-primary">Đã duyệt</span>
  <% } else { %>
    <span class="label label-default"><%= order.ghn_status_name || "Đang xử lý" %></span>
  <% } %>
</td>
                      <td style="text-align:center;">
  <!-- Nút xem chi tiết -->
  <a href="/admin/orders/detail/<%= order._id %>" class="btn btn-info btn-xs" title="Xem chi tiết">
    <i class="glyphicon glyphicon-eye-open"></i>
  </a>

  <!-- Nút duyệt đơn (chỉ hiện khi đang xử lý) -->
  <% if(order.status === 2){ %>
    <form action="/admin/order/<%= order._id %>/approve" method="POST" style="display:inline" onsubmit="return confirm('Xác nhận duyệt đơn hàng này?')">
      <button type="submit" class="btn btn-success btn-xs" title="Duyệt đơn">
        <i class="glyphicon glyphicon-ok"></i>
      </button>
    </form>
  <% } %>

  <!-- Nút hủy đơn (chỉ hiện nếu chưa thanh toán) -->
  <% if(order.payment_status === 'unpaid' && order.status === 2){ %>
    <form action="/admin/order/<%= order._id %>/cancel" method="POST" style="display:inline" onsubmit="return confirm('Bạn có chắc chắn muốn hủy đơn hàng này?')">
      <button type="submit" class="btn btn-danger btn-xs" title="Hủy đơn">
        <i class="glyphicon glyphicon-trash"></i>
      </button>
    </form>
  <% } %>
</td>

                    </tr>
                  <% }) %>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>

        <!-- ✅ Phân trang -->
        <div class="panel-footer">
          <nav aria-label="Page navigation">
            <ul class="pagination" style="margin: 0;">
              <% if(page > 1){ %>
                <li>
                  <a href="/admin/orders?page=<%= page - 1 %>">&laquo;</a>
                </li>
              <% } %>
              <% pages.forEach(item => { %>
                <li class="<%= item === page ? 'active' : '' %>">
                  <% if(item === "..."){ %>
                    <span><%= item %></span>
                  <% } else { %>
                    <a href="/admin/orders?page=<%= item %>"><%= item %></a>
                  <% } %>
                </li>
              <% }) %>
              <% if(page < totalPages){ %>
                <li>
                  <a href="/admin/orders?page=<%= page + 1 %>">&raquo;</a>
                </li>
              <% } %>
            </ul>
          </nav>
        </div>

      </div>
    </div>
  </div>

</div>

<script src="/js/jquery-1.11.1.min.js"></script>
<script src="/js/bootstrap.min.js"></script>

<%- include("../layout/footer.ejs")%>

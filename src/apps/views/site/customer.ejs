<%- include("layouts/head.ejs", { title: "Thông tin tài khoản" }) %> <%-
include("layouts/header.ejs") %> <%- include("layouts/menu.ejs") %>

<!-- Body -->
<div class="container">
  <div class="row justify-content-center mt-5">
    <div class="col-lg-6 col-md-8 col-sm-12">
      <div class="card">
        <div class="card-header text-center fw-bold">Thông tin tài khoản</div>
        <div class="card-body">
          <% if (alert) { %>
          <div class="alert alert-<%= alertCls %> text-center">
            <%= alert %>
          </div>
          <% } %>

          <form action="/customer/update" method="POST">
            <div class="form-group mb-3">
              <label>Họ và tên</label>
              <input
                type="text"
                class="form-control"
                name="fullName"
                value="<%= customer.full_name %>"
                placeholder="Nhập họ và tên"
                required
              />
            </div>

            <div class="form-group mb-3">
              <label>Địa chỉ email</label>
              <input
                type="email"
                class="form-control"
                name="email"
                value="<%= customer.email %>"
                disabled
              />
            </div>

            <div class="form-group mb-3">
              <label>Số điện thoại</label>
              <input
                type="text"
                class="form-control"
                name="phone"
                value="<%= customer.phone %>"
                disabled
              />
            </div>

            <!-- Địa chỉ -->
            <div class="form-group mb-3">
              <label>Tỉnh/Thành phố</label>
              <select
                class="form-control"
                name="province_id"
                id="province"
                required
              >
                <option value="">Chọn tỉnh/thành</option>
              </select>
            </div>

            <div class="form-group mb-3">
              <label>Quận/Huyện</label>
              <select
                class="form-control"
                name="district_id"
                id="district"
                required
              >
                <option value="">Chọn quận/huyện</option>
              </select>
            </div>

            <div class="form-group mb-3">
              <label>Phường/Xã</label>
              <select class="form-control" name="ward_code" id="ward" required>
                <option value="">Chọn phường/xã</option>
              </select>
            </div>

            <div class="form-group mb-3">
              <label>Địa chỉ cụ thể</label>
              <input
                type="text"
                class="form-control"
                name="address"
                value="<%= customer.address || '' %>"
                placeholder="Nhập số nhà, tên đường..."
                required
              />
            </div>

            <div class="text-center mt-3">
              <button type="submit" class="btn btn-primary px-4">
                Cập nhật
              </button>
              <a href="/" class="btn btn-secondary ms-2">Về trang chủ</a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- End Body -->

<%- include("layouts/footer.ejs") %>

<script>
  const token = "1755fed2-bf9b-11f0-a51e-f64be07fcf0a";
  const provinceSelect = document.getElementById("province");
  const districtSelect = document.getElementById("district");
  const wardSelect = document.getElementById("ward");

  const customerProvince = Number("<%= customer.province_id || '' %>");
  const customerDistrict = Number("<%= customer.district_id || '' %>");
  const customerWard = "<%= customer.ward_code || '' %>";

  // Load provinces
  fetch(
    "https://dev-online-gateway.ghn.vn/shiip/public-api/master-data/province",
    {
      method: "GET",
      headers: { token },
    }
  )
    .then((res) => res.json())
    .then((data) => {
      data.data.forEach((province) => {
        const opt = document.createElement("option");
        opt.value = province.ProvinceID;
        opt.text = province.ProvinceName;
        if (province.ProvinceID === customerProvince) opt.selected = true;
        provinceSelect.add(opt);
      });
      if (customerProvince) provinceSelect.dispatchEvent(new Event("change"));
    });

  // Load districts
  provinceSelect.addEventListener("change", () => {
    districtSelect.innerHTML = '<option value="">Chọn quận/huyện</option>';
    wardSelect.innerHTML = '<option value="">Chọn phường/xã</option>';
    const province_id = provinceSelect.value;
    if (!province_id) return;

    fetch(
      "https://dev-online-gateway.ghn.vn/shiip/public-api/master-data/district",
      {
        method: "POST",
        headers: { "Content-Type": "application/json", token },
        body: JSON.stringify({ province_id: Number(province_id) }),
      }
    )
      .then((res) => res.json())
      .then((data) => {
        data.data.forEach((district) => {
          const opt = document.createElement("option");
          opt.value = district.DistrictID;
          opt.text = district.DistrictName;
          if (district.DistrictID === customerDistrict) opt.selected = true;
          districtSelect.add(opt);
        });
        if (customerDistrict) districtSelect.dispatchEvent(new Event("change"));
      });
  });

  // Load wards
  districtSelect.addEventListener("change", () => {
    wardSelect.innerHTML = '<option value="">Chọn phường/xã</option>';
    const district_id = districtSelect.value;
    if (!district_id) return;

    fetch(
      `https://dev-online-gateway.ghn.vn/shiip/public-api/master-data/ward?district_id=${district_id}`,
      {
        method: "GET",
        headers: { token },
      }
    )
      .then((res) => res.json())
      .then((data) => {
        data.data.forEach((ward) => {
          const opt = document.createElement("option");
          opt.value = ward.WardCode;
          opt.text = ward.WardName;
          if (ward.WardCode === customerWard) opt.selected = true;
          wardSelect.add(opt);
        });
      });
  });
</script>
